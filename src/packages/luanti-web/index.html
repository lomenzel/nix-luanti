<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Luanti Web Edition</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --mc-border-light: #ffffff;
        --mc-border-dark: #000000;
        --mc-button-gray: #7c7c7c;
        --mc-button-hover: #5a8eaf;
        --mc-ui-bg: #c6c6c6;
      }

      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        width: 100vw;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background:
          linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)),
          url("background.png");
        background-size: cover;
        background-position: center;
        font-family: "Press Start 2P", cursive;
        color: white;
        overflow: hidden;
      }

      html {
        margin: 0;
        padding: 0;
      }

      /* Logo Area */
      .header-container {
        position: relative;
        text-align: center;
        margin-bottom: 40px;
        filter: drop-shadow(4px 4px 0px #000);
      }

      .main-title {
        font-size: 42px;
        margin: 0;
        letter-spacing: 2px;
        color: #bebebe;
        text-transform: uppercase;
      }

      .sub-title {
        font-size: 14px;
        margin-top: 10px;
        color: #727272;
      }

      /* Yellow Splash Text */
      .splash {
        position: absolute;
        right: -120px;
        top: 30px;
        color: #ffff00;
        font-size: 12px;
        transform: rotate(-20deg);
        text-shadow: 2px 2px 0px #3f3f00;
        animation: splashAnim 0.5s infinite alternate;
        pointer-events: none;
        width: max-content;
      }

      @keyframes splashAnim {
        from {
          transform: rotate(-20deg) scale(1);
        }

        to {
          transform: rotate(-20deg) scale(1.1);
        }
      }

      /* Menu Container */
      .menu-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 400px;
        align-items: center;
        z-index: 10;
      }

      input[type="text"],
      input[type="password"] {
        width: 100%;
        background-color: black;
        border: 2px solid #333;
        padding: 12px;
        color: #4caf50;
        font-family: "Press Start 2P", cursive;
        font-size: 12px;
        box-sizing: border-box;
        outline: none;
        margin-bottom: 10px;
      }

      /* Minecraft Button Style */
      .mc-button {
        width: 100%;
        position: relative;
        background-color: #666;
        border: 2px solid black;
        padding: 14px;
        color: #e0e0e0;
        font-family: "Press Start 2P", cursive;
        font-size: 14px;
        cursor: pointer;
        text-shadow: 2px 2px 0px #000;
        box-shadow:
          inset 2px 2px 0px #888,
          inset -2px -2px 0px #444;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
      }

      .mc-button:hover {
        background-color: var(--mc-button-hover);
        color: #fff;
        border-color: white;
      }

      .mc-button:active {
        box-shadow:
          inset -2px -2px 0px #888,
          inset 2px 2px 0px #444;
      }

      .half-buttons {
        display: flex;
        gap: 10px;
        width: 100%;
      }

      /* Modal Styling */
      #about_modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        z-index: 100;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background-color: var(--mc-ui-bg);
        border: 4px solid black;
        box-shadow:
          inset 4px 4px 0px #eee,
          inset -4px -4px 0px #555;
        padding: 30px;
        width: 450px;
        color: #333;
        text-align: center;
      }

      .modal-content h2 {
        font-size: 16px;
        margin-bottom: 20px;
        text-shadow: none;
      }

      .link-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
      }

      .modal-content .mc-button {
        font-size: 10px;
        padding: 10px;
      }

      /* Details/Logs */
      details.log-panel {
        position: absolute;
        bottom: 10px;
        left: 10px;
        width: 300px;
        font-size: 8px;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid #555;
        z-index: 5;
      }

      details.log-panel summary {
        padding: 5px;
        cursor: pointer;
      }

      #temporary_console {
        height: 100px;
        overflow-y: scroll;
        padding: 5px;
        font-family: monospace;
      }

      .version-tag {
        position: absolute;
        bottom: 10px;
        right: 10px;
        font-size: 10px;
      }
    </style>
  </head>

  <body>
    <div class="header-container">
      <h1 class="main-title">LUANTI</h1>
      <div id="sub-title" class="sub-title">WEB EDITION</div>
      <div class="splash" id="splash_text">Stay strong!</div>
    </div>

    <div id="join_form" class="menu-container">
      <input
        type="text"
        id="join_username"
        placeholder="PLAYER NAME"
        maxlength="19"
      />
      <input
        type="password"
        id="join_user_password"
        placeholder="PASSWORD"
        autocomplete="off"
      />

      <button class="mc-button" id="join_launch">Multiplayer</button>
      <button class="mc-button" id="menu_launch">Singleplayer</button>

      <div class="half-buttons">
        <button class="mc-button" style="font-size: 10px" id="about_open">
          About...
        </button>
        <button
          class="mc-button"
          id="quit-button"
          style="font-size: 10px"
          onclick="window.close()"
        >
          Quit Game
        </button>
      </div>
    </div>

    <!-- Credits Modal -->
    <div id="about_modal">
      <div class="modal-content">
        <h2>CREDITS</h2>
        <div class="link-list">
          <a href="https://luanti.org" target="_blank" class="mc-button"
            >Luanti.org</a
          >
          <a
            href="https://github.com/paradust7/minetest-wasm"
            target="_blank"
            class="mc-button"
            >Minetest WASM</a
          >
          <a
            href="https://github.com/lomenzel/nix-luanti"
            target="_blank"
            class="mc-button"
            >Nix Luanti</a
          >
        </div>
        <button
          class="mc-button"
          id="about_close"
          style="background-color: #888"
        >
          Done
        </button>
      </div>
    </div>

    <div class="version-tag">
      Luanti 5.10.0-wasm <br \ />
      Â© background image:
      <a href="https://github.com/luanti-org/minetest_game" target="_blank"
        >Minetest Game</a
      >
    </div>

    <details class="log-panel">
      <summary>System Logs</summary>
      <div id="temporary_console"></div>
    </details>

    <script
      type="text/javascript"
      src="%__RELEASE_UUID__%/launcher.js"
    ></script>
    <script type="text/javascript" src="config.js"></script>
    <script type="text/javascript">
      const splashes = [
        "100% Reproducible!",
        "Check your /nix/store!",
        "Also try 0 A.D.!",
        "Also try SuperTuxKart!",
        "Lua-tastic!",
        "Nodes, nodes everywhere!",
        "It's an engine!",
      ];
      document.getElementById("splash_text").innerText =
        splashes[Math.floor(Math.random() * splashes.length)];
      document.getElementById("sub-title").innerText =
        SERVER_NAME || "WEB EDITION";

      if (HAS_MAPSERVER) {
        document.getElementById("quit-button").innerText = "Display Map";
        document.getElementById("quit-button").onclick = () => {
          window.open("/map", "_blank");
        };
      }

      // Modal Logic
      const modal = document.getElementById("about_modal");
      document.getElementById("about_open").onclick = () =>
        (modal.style.display = "flex");
      document.getElementById("about_close").onclick = () =>
        (modal.style.display = "none");
      window.onclick = (event) => {
        if (event.target == modal) modal.style.display = "none";
      };

      const mtl = new MinetestLauncher();
      const tcon = document.getElementById("temporary_console");

      function tcon_print(prefix, line) {
        const p = document.createElement("div");
        p.innerText = (prefix || "") + line;
        tcon.appendChild(p);
        tcon.scrollTop = tcon.scrollHeight;
      }

      function enableJoinForm() {
        document.getElementById("join_launch").addEventListener("click", () => {
          const args = new MinetestArgs();
          args.name =
            document.getElementById("join_username").value || "Player";
          args.address = DOMAIN;
          args.port = PORT;
          args.password = document.getElementById("join_user_password").value;
          args.go = true;
          if (args.username === "")
            alert(
              "Warning: You are trying to join a server without a username.",
            );
          mtl.setProxy(PROXY_URL);
          mtl.setConf("viewing_range", 85);
          mtl.setConf("max_block_send_distance", 5);
          mtl.setConf("max_block_generate_distance", 5);
          if (HAS_TEXTURE_PACK)
            mtl.setConf(
              "texture_path",
              "/minetest/textures/enabled_texture_pack",
            );
          mtl.launch(args);
        });

        document.getElementById("menu_launch").addEventListener("click", () => {
          const args = new MinetestArgs();
          args.name =
            document.getElementById("join_username").value || "Player";
          args.go = false;
          mtl.setProxy(PROXY_URL);
          mtl.setConf("viewing_range", 85);
          mtl.setConf("max_block_send_distance", 5);
          mtl.setConf("max_block_generate_distance", 5);
          mtl.setConf("remote_port", PORT);
          mtl.setConf("address", DOMAIN);
          if (HAS_TEXTURE_PACK)
            mtl.setConf(
              "texture_path",
              "/minetest/textures/enabled_texture_pack",
            );
          mtl.launch(args);
        });
      }

      function queryProxy(cmd, proxy) {
        return new Promise((resolve, reject) => {
          let finished = false;
          const ws = new WebSocket(proxy);
          ws.addEventListener("open", (event) => {
            ws.send(cmd);
          });
          ws.addEventListener("error", (event) => {
            alert("Error initiating proxy connection");
            finished = true;
            reject(new Error("Received error"));
          });
          ws.addEventListener("close", (event) => {
            if (!finished) {
              alert("Proxy connection closed unexpectedly");
              finished = true;
              reject(new Error("Received close"));
            }
          });
          ws.addEventListener("message", (event) => {
            if (typeof event.data !== "string") {
              alert("Invalid message received from proxy");
              finished = true;
              reject(new Error("Invalid message"));
              return;
            }
            finished = true;
            ws.close();
            resolve(event.data.split(" "));
          });
        });
      }

      mtl.onprint = (text) => tcon_print("", text);
      mtl.onready = () => enableJoinForm();
    </script>
  </body>
</html>
